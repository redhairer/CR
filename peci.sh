#!/bin/bash

read_tsod()
{
#CPU0 Channel 0-3
echo "CPU0 Channel 0-3"
ipmitool -b 6 -t 0x2c raw 0x2E 0x4B 0x57 0x01 0x00 0x00 0x33 0x33 0x00 0x00 0x00 0x00 0x00 0x00

#CPU0 Channel 4-5
echo "CPU0 Channel 4-7"
ipmitool -b 6 -t 0x2c raw 0x2E 0x4B 0x57 0x01 0x00 0x40 0x33 0x00 0x00 0x00 0x00 0x00 0x00 0x00

#CPU1 Channel 0-3
echo "CPU1 Channel 0-3"
ipmitool -b 6 -t 0x2c raw 0x2E 0x4B 0x57 0x01 0x00 0x00 0x00 0x00 0x33 0x33 0x00 0x00 0x00 0x00

#CPU1 Channel 4-5
echo "CPU1 Channel 4-7"
ipmitool -b 6 -t 0x2c raw 0x2E 0x4B 0x57 0x01 0x00 0x40 0x00 0x00 0x33 0x00 0x00 0x00 0x00 0x00

}

read_tsod_poll_en()
{
	#read Bus: B(1) Device: 30 Function: 5 Offset: 9C
	ipmitool -b 6 -t 0x2c raw  0x2E 0x40 0x57 0x01 0x00 0x30 0x05 0x05 0xE1 0x00 0x9C 0x50 0x1F
}

#disable tsod
disable_tsod_polling()
{
	read_tsod_poll_en
	ipmitool -b 6 -t 0x2c raw 0x2E 0x40 0x57 0x01 0x00 0x30 0x0A 0x01 0xE5 0x00 0x9C 0x50 0x1F 0x40 0x59 0x00 0x20
	read_tsod_poll_en
}

#read d0f4 offset 0 BSR
readBSR()
{
	echo "read BSR wo PEC"
	ipmitool -t 0x2c -b 6 raw 0x2e 0x48 0x57 0x01 0x00 0x00 0x00 0xB2 0x80 0x00 0x00
	ipmitool -t 0x2c -b 6 raw 0x2e 0x48 0x57 0x01 0x00 0x00 0x00 0xB2 0x00 0x01 0x04 0x00
	ipmitool -t 0x2c -b 6 raw 0x2e 0x48 0x57 0x01 0x00 0x00 0x00 0xB2 0x40 0x00 0x00

	ipmitool -t 0x2c -b 6 raw 0x2e 0x47 0x57 0x01 0x00 0x00 0x00 0xB2 0x80 0x00
	ipmitool -t 0x2c -b 6 raw 0x2e 0x47 0x57 0x01 0x00 0x00 0x00 0xB2 0x00 0x02
	ipmitool -t 0x2c -b 6 raw 0x2e 0x47 0x57 0x01 0x00 0x00 0x00 0xB2 0x40 0x00
}

readBSR_PEC()
{
        echo "read BSR w PEC"
        ipmitool -t 0x2c -b 6 raw 0x2e 0x48 0x57 0x01 0x00 0x00 0x00 0xB2 0x90 0x01 0x00 0x55
        ipmitool -t 0x2c -b 6 raw 0x2e 0x48 0x57 0x01 0x00 0x00 0x00 0xB2 0x10 0x01 0x04 0x55
        ipmitool -t 0x2c -b 6 raw 0x2e 0x48 0x57 0x01 0x00 0x00 0x00 0xB2 0x10 0x01 0x00 0x55
        ipmitool -t 0x2c -b 6 raw 0x2e 0x48 0x57 0x01 0x00 0x00 0x00 0xB2 0x50 0x01 0x00 0x55

        ipmitool -t 0x2c -b 6 raw 0x2e 0x47 0x57 0x01 0x00 0x00 0x00 0xB2 0x90 0x00
        ipmitool -t 0x2c -b 6 raw 0x2e 0x47 0x57 0x01 0x00 0x00 0x00 0xB2 0x10 0x02
        ipmitool -t 0x2c -b 6 raw 0x2e 0x47 0x57 0x01 0x00 0x00 0x00 0xB2 0x50 0x00

}

#read d1f4 offset 8 VID_DID
read_VIDDID()
{
	echo "read VID_DID"
	ipmitool -t 0x2c -b 6 raw 0x2e 0x48 0x57 0x01 0x00 0x00 0x00 0xB2 0x80 0x00 0x00
	ipmitool -t 0x2c -b 6 raw 0x2e 0x48 0x57 0x01 0x00 0x00 0x00 0xB2 0x00 0x01 0x0c 0x00
	ipmitool -t 0x2c -b 6 raw 0x2e 0x48 0x57 0x01 0x00 0x00 0x00 0xB2 0x40 0x00 0x08

	ipmitool -t 0x2c -b 6 raw 0x2e 0x47 0x57 0x01 0x00 0x00 0x00 0xB2 0x80 0x00
	ipmitool -t 0x2c -b 6 raw 0x2e 0x47 0x57 0x01 0x00 0x00 0x00 0xB2 0x00 0x02
	ipmitool -t 0x2c -b 6 raw 0x2e 0x47 0x57 0x01 0x00 0x00 0x00 0xB2 0x40 0x00

	echo "read revID"
	ipmitool -t 0x2c -b 6 raw 0x2e 0x48 0x57 0x01 0x00 0x00 0x00 0xB2 0x80 0x00 0x00
	ipmitool -t 0x2c -b 6 raw 0x2e 0x48 0x57 0x01 0x00 0x00 0x00 0xB2 0x00 0x01 0x0c 0x00
	ipmitool -t 0x2c -b 6 raw 0x2e 0x48 0x57 0x01 0x00 0x00 0x00 0xB2 0x40 0x00 0x0c

	ipmitool -t 0x2c -b 6 raw 0x2e 0x47 0x57 0x01 0x00 0x00 0x00 0xB2 0x80 0x00
	ipmitool -t 0x2c -b 6 raw 0x2e 0x47 0x57 0x01 0x00 0x00 0x00 0xB2 0x00 0x02
	ipmitool -t 0x2c -b 6 raw 0x2e 0x47 0x57 0x01 0x00 0x00 0x00 0xB2 0x40 0x00

}

send_mailbox_cmd()
{
	echo "Identify DIMM (01h)/Identify (00h)"
	ipmitool -b 6 -t 0x2c raw 0x2E  0x49 0x57 0x01 0x00 0x00 0x01 0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x24 0x00 0x08 0x00
	ipmitool -b 6 -t 0x2c raw 0x2E  0x4a 0x57 0x01 0x00 0x00
}

read_tsod
#disable_tsod_polling
readBSR
#readBSR_PEC

read_VIDDID
send_mailbox_cmd


